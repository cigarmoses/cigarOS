<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Loyalty</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f5f6fa; margin:0; padding:20px; }
    .filters { margin-bottom:15px; }
    .filter-btn { padding:8px 14px; margin-right:8px; border:none; border-radius:6px; cursor:pointer; }
    .filter-btn.active { font-weight:bold; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:10px; text-align:left; }
    th { background:#f1f1f1; }
    tr:nth-child(even) { background:#fafafa; }
    tr.locker { background:#0074D9; color:white; }
    .badge-icon { width:20px; vertical-align:middle; margin-right:6px; }
    .last-name { font-weight:bold; }
    .first-name { font-weight:normal; }
  </style>
</head>
<body>
  <input type="text" id="search" placeholder="Search" style="width:100%;padding:10px;margin-bottom:15px;" />

  <div class="filters">
    <button class="filter-btn" data-filter="locker">Locker members</button>
    <button class="filter-btn" data-filter="regular">Regulars</button>
  </div>

  <table>
    <thead>
      <tr>
        <th></th>
        <th>Name</th>
        <th>Pts</th>
        <th>Last Visit</th>
      </tr>
    </thead>
    <tbody id="loyalty-list"></tbody>
  </table>

  <script>
    async function loadLoyalty() {
      try {
        const res = await fetch('/.netlify/functions/get-loyalty');
        const data = await res.json();
        if (!data.ok) throw new Error('Failed to load');
        renderTable(data.data);
      } catch (err) {
        document.getElementById('loyalty-list').innerHTML =
          `<tr><td colspan="4" style="color:red;">Error: ${err.message}</td></tr>`;
      }
    }

    function renderTable(records) {
      const tbody = document.getElementById('loyalty-list');
      tbody.innerHTML = '';

      records.forEach((r) => {
        const tr = document.createElement('tr');
        if (r.badges.locker) tr.classList.add('locker');

        let icon = '';
        if (r.badges.military) icon = '<img class="badge-icon" src="/img/military.svg" />';
        else if (r.badges.responder) icon = '<img class="badge-icon" src="/img/firstresponders.svg" />';
        else if (r.badges.locker) icon = '<img class="badge-icon" src="/img/lockermember.svg" />';

        tr.innerHTML = `
          <td>${icon}</td>
          <td><span class="last-name">${r.last}</span> <span class="first-name">${r.first}</span></td>
          <td>${r.points}</td>
          <td>${r.lastVisit}</td>
        `;
        tbody.appendChild(tr);
      });

      // Search
      document.getElementById('search').addEventListener('input', (e) => {
        const q = e.target.value.toLowerCase();
        Array.from(tbody.rows).forEach((row) => {
          row.style.display = row.innerText.toLowerCase().includes(q) ? '' : 'none';
        });
      });

      // Filters
      document.querySelectorAll('.filter-btn').forEach((btn) => {
        btn.onclick = () => {
          document.querySelectorAll('.filter-btn').forEach((b) => b.classList.remove('active'));
          btn.classList.add('active');

          const filter = btn.dataset.filter;
          Array.from(tbody.rows).forEach((row) => {
            if (filter === 'locker' && !row.classList.contains('locker')) row.style.display = 'none';
            else if (filter === 'regular' && row.classList.contains('locker')) row.style.display = 'none';
            else row.style.display = '';
          });
        };
      });
    }

    loadLoyalty();
  </script>
</body>
</html>
