<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Loyalty</title>
  <style>
    :root{
      --bg:#f4f6f9; --card:#ffffff; --text:#1a1a1a; --muted:#6b7280;
      --line:#e5e7eb; --blue:#2b6cb0; --orange:#dd6b20; --chip-bg:#eef2f7;
      --zebra:#f7f9fc; --shadow:0 1px 2px rgba(0,0,0,.03), 0 10px 30px rgba(0,0,0,.03);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}

    .wrap{max-width:980px;margin:0 auto;padding:18px 14px 28px;}

    /* Search + chips */
    .searchbar{position:sticky;top:0;z-index:5;background:var(--bg);padding-bottom:10px;}
    .search{width:100%;height:56px;border-radius:18px;border:1px solid var(--line);
      background:#fff;padding:0 18px;font-size:20px;outline:none;box-shadow:0 1px 0 rgba(0,0,0,.02);}
    .chips{display:flex;gap:16px;margin-top:14px;flex-wrap:wrap}
    .chip{background:var(--chip-bg);border-radius:14px;padding:10px 14px;color:#6b7280;font-weight:600;
      display:flex;align-items:center;gap:10px;user-select:none;cursor:pointer}
    .chip.active{filter:saturate(1.1);background:#e9eef7;color:#1f2937}
    .dot{width:18px;height:18px;border-radius:6px}
    .dot.blue{background:var(--blue)} .dot.orange{background:var(--orange)}

    /* Card + grid */
    .card{margin-top:14px;background:var(--card);border-radius:18px;padding:12px;box-shadow:var(--shadow);}
    .thead{display:grid;grid-template-columns:1.2fr .5fr .6fr 1fr;gap:12px;color:#374151;
      font-weight:800;font-size:22px;padding:8px 12px 14px 12px;}
    .rows{border-top:1px solid var(--line)}
    .row{display:grid;grid-template-columns:1.2fr .5fr .6fr 1fr;gap:12px;padding:14px 12px;
      border-bottom:1px solid var(--line);align-items:center}
    .row:last-child{border-bottom:0}

    /* Neutral zebra (default) */
    .row.neutral{background:#fff}
    .row.neutral:nth-child(odd){background:var(--zebra)}

    /* Colored rows only when explicitly labeled */
    .row.locker{background:var(--blue);color:#fff;border-bottom-color:rgba(255,255,255,.28)}
    .row.regular{background:var(--orange);color:#fff;border-bottom-color:rgba(255,255,255,.28)}
    .row.locker .name div,
    .row.regular .name div,
    .row.locker .last,
    .row.regular .last,
    .row.locker .notes,
    .row.regular .notes { color:#fff; }

    .name{display:flex;flex-direction:column;font-weight:800;font-size:22px;line-height:1.05;}
    .locker-tag{font-weight:700;font-size:16px;margin-bottom:4px}
    .pts{font-weight:800;font-size:20px}
    .last{font-weight:700;font-size:20px;color:#6b7280}
    .notes{font-weight:700;font-size:20px;color:#6b7280}
    .notes .edit{opacity:.9}
    .pts-editor, .notes-editor{display:flex;gap:8px;align-items:flex-start}
    input[type="number"], textarea{
      width:100%;border-radius:10px;border:1px solid var(--line);padding:8px 10px;font-size:18px;background:#fff;
    }
    textarea{min-height:46px}
    .btn{appearance:none;border:1px solid var(--line);background:#111;color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn.secondary{background:#fff;color:#111}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    @media (max-width:640px){ .thead{font-size:18px} .name{font-size:20px} .pts,.last,.notes{font-size:18px} .row{padding:12px}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="searchbar">
      <!-- placeholder now just "Search" -->
      <input id="q" class="search" type="search" placeholder="Search" />
      <div class="chips">
        <div id="chip-locker" class="chip active" role="button" tabindex="0">
          <span class="dot blue"></span> Locker members
        </div>
        <div id="chip-regular" class="chip active" role="button" tabindex="0">
          <span class="dot orange"></span> Regulars
        </div>
      </div>
    </div>

    <div class="card">
      <div class="thead">
        <div>Name</div>
        <div>Pts</div>
        <div>Last</div>
        <div>Notes</div>
      </div>
      <div id="rows" class="rows"></div>
    </div>
  </div>

  <script>
    // We now receive normalized keys from the server:
    // { first, last, aka, points, lastPurchase, notes, locker, regular, email, phone, birthday }
    let ALL = [];
    let filters = { locker: true, regular: true };
    const $ = (s)=>document.querySelector(s);
    const rowsEl = $('#rows');
    const chipLocker = $('#chip-locker');
    const chipRegular = $('#chip-regular');

    chipLocker.addEventListener('click', ()=>{ filters.locker=!filters.locker; chipLocker.classList.toggle('active',filters.locker); render(); });
    chipRegular.addEventListener('click', ()=>{ filters.regular=!filters.regular; chipRegular.classList.toggle('active',filters.regular); render(); });
    $('#q').addEventListener('input', render);

    const isLocker = (r)=> (r.locker || '').trim() !== '';
    const isRegular = (r)=> (r.regular || '').trim() !== '';
    const variant = (r)=> isLocker(r) ? 'locker' : (isRegular(r) ? 'regular' : 'neutral');

    const fmtPts = (n)=>{
      const num = Number(n||0);
      if (!isFinite(num)) return '0';
      if (Math.abs(num) >= 1000) return (num/1000).toFixed(num%1000===0?0:1)+'k';
      return String(num);
    };
    const fmtDate = (v)=> (v && String(v).trim()) || 'â€”';

    const EDIT = {}; // id -> {notes:boolean, pts:boolean}
    const idFor = (r)=> encodeURIComponent((r.email||'').trim() || `${(r.last||'').trim()}|${(r.first||'').trim()}`);

    function rowHTML(r, editingNotes=false, editingPts=false){
      const v = variant(r);
      const id = idFor(r);
      const lockerTag = isLocker(r) ? `#${r.locker}` : '';
      const nameTop = r.last || '';
      const nameBot = r.first || '';

      const ptsCell = editingPts ? `
        <div class="pts-editor">
          <input id="pts-input-${id}" type="number" min="0" step="1" value="${Number(r.points)||0}" />
          <div style="display:flex;flex-direction:column;gap:8px">
            <button class="btn" onclick='savePoints("${id}")'>Save</button>
            <button class="btn secondary" onclick='cancelPts("${id}")'>Cancel</button>
          </div>
        </div>` : `
        <div>
          <div class="pts">${fmtPts(r.points)}</div>
          <div style="margin-top:8px"><button class="btn secondary" onclick='startPts("${id}")'>Edit</button></div>
        </div>`;

      const notesCell = editingNotes ? `
        <div class="notes-editor">
          <textarea id="notes-input-${id}">${(r.notes||'').replace(/</g,'&lt;')}</textarea>
          <div style="display:flex;flex-direction:column;gap:8px">
            <button class="btn" onclick='saveNotes("${id}")'>Save</button>
            <button class="btn secondary" onclick='cancelNotes("${id}")'>Cancel</button>
          </div>
        </div>` : `
        <div>
          <div class="notes"><span class="edit">${r.notes || ''}</span></div>
          <div style="margin-top:8px"><button class="btn secondary" onclick='startNotes("${id}")'>Edit</button></div>
        </div>`;

      return `
        <div class="row ${v}" data-id="${id}">
          <div class="name">
            ${lockerTag ? `<div class="locker-tag">${lockerTag}</div>` : ``}
            <div>${nameTop}</div>
            <div>${nameBot}</div>
          </div>
          ${ptsCell}
          <div class="last">${fmtDate(r.lastPurchase)}</div>
          ${notesCell}
        </div>`;
    }

    function findIndexById(id){
      const dec = decodeURIComponent(id);
      const pipe = dec.indexOf('|');
      return ALL.findIndex(x => {
        if ((x.email||'').trim().toLowerCase() === dec.toLowerCase()) return true;
        if (pipe > -1) {
          const last = dec.slice(0, pipe).trim().toLowerCase();
          const first = dec.slice(pipe+1).trim().toLowerCase();
          return (x.last||'').trim().toLowerCase() === last && (x.first||'').trim().toLowerCase() === first;
        }
        return false;
      });
    }

    function render(){
      const q = ($('#q').value||'').toLowerCase();
      const list = ALL.filter(r=>{
        if (isLocker(r) && !filters.locker) return false;
        if (isRegular(r) && !filters.regular) return false;

        if (!q) return true;
        const hay = [
          r.first, r.last, r.aka, r.email, r.phone, r.locker, r.regular, r.notes
        ].map(v => (v||'').toLowerCase());
        return hay.some(s => s.includes(q));
      });

      rowsEl.innerHTML = list.map(r => {
        const id = idFor(r);
        const st = EDIT[id] || {notes:false, pts:false};
        return rowHTML(r, st.notes, st.pts);
      }).join('') || `<div style="padding:18px;color:#6b7280;">No results</div>`;
    }

    // Notes editing
    window.startNotes = (id)=>{ EDIT[id] = {...(EDIT[id]||{}), notes:true}; render(); setTimeout(()=>{ const t = document.getElementById(`notes-input-${id}`); if(t) t.focus(); }, 0); };
    window.cancelNotes = (id)=>{ EDIT[id] = {...(EDIT[id]||{}), notes:false}; render(); };
    window.saveNotes = async (id)=>{
      const idx = findIndexById(id); if (idx<0) return;
      const r = ALL[idx];
      const notes = (document.getElementById(`notes-input-${id}`)?.value || '').trim();
      try{
        const res = await fetch('/.netlify/functions/update-notes', {
          method: 'POST',
          headers: {'content-type':'application/json'},
          body: JSON.stringify({
            email: r.email || undefined,
            firstName: r.first || undefined,
            lastName: r.last || undefined,
            aka: r.aka || undefined,
            notes
          })
        });
        const json = await res.json(); if(!json.ok) throw new Error(json.error||'Save failed');
        ALL[idx].notes = notes; EDIT[id] = {...(EDIT[id]||{}), notes:false}; render();
      }catch(e){ alert('Error saving notes: '+e.message); }
    };

    // Points editing
    window.startPts = (id)=>{ EDIT[id] = {...(EDIT[id]||{}), pts:true}; render(); setTimeout(()=>{ const t = document.getElementById(`pts-input-${id}`); if(t) t.focus(); }, 0); };
    window.cancelPts = (id)=>{ EDIT[id] = {...(EDIT[id]||{}), pts:false}; render(); };
    window.savePoints = async (id)=>{
      const idx = findIndexById(id); if (idx<0) return;
      const r = ALL[idx];
      const points = Number(document.getElementById(`pts-input-${id}`)?.value || 0);
      try{
        const res = await fetch('/.netlify/functions/update-points', {
          method: 'POST',
          headers: {'content-type':'application/json'},
          body: JSON.stringify({
            email: r.email || undefined,
            firstName: r.first || undefined,
            lastName: r.last || undefined,
            aka: r.aka || undefined,
            points
          })
        });
        const json = await res.json(); if(!json.ok) throw new Error(json.error||'Save failed');
        ALL[idx].points = points; EDIT[id] = {...(EDIT[id]||{}), pts:false}; render();
      }catch(e){ alert('Error saving points: '+e.message); }
    };

    async function boot(){
      try{
        const res = await fetch('/.netlify/functions/get-loyalty', { cache:'no-store' });
        const json = await res.json();
        if(!json.ok) throw new Error(json.error || 'Load failed');
        ALL = Array.isArray(json.data) ? json.data : [];
        render();
      }catch(e){
        rowsEl.innerHTML = `<div style="padding:18px;color:#b91c1c;">Error loading loyalty data: ${e.message}</div>`;
        console.error(e);
      }
    }
    document.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>
