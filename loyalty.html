<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Loyalty</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; padding: 0; background: #f9f9f9; }
    .loyalty-wrap { padding: 12px; }
    #loyalty-search { width:100%; padding:10px 12px; border-radius:8px; border:1px solid #ddd; }
    .loyalty-list { list-style:none; margin:12px 0 0; padding:0; }
    .loyalty-row { display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid #eee; cursor:pointer; }
    .loyalty-row:hover { background:#fafafa; }
    .badge { font-size:12px; padding:2px 8px; border-radius:999px; color:#fff; }
    .badge.blue { background:#2b6cb0; }   /* locker */
    .badge.orange { background:#dd6b20; } /* regular */
    .loyalty-modal { position:fixed; inset:0; background:rgba(0,0,0,.4); display:grid; place-items:center; }
    .modal-card { width:min(680px,92vw); background:#fff; border-radius:12px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.2); }
    .modal-close { float:right; border:0; background:transparent; font-size:18px; cursor:pointer; }
    .kv { display:grid; grid-template-columns:140px 1fr; gap:6px 12px; margin:10px 0; }
    .kv b { color:#444; }
    .truncate { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:52vw; }
  </style>
</head>
<body>

  <!-- Loyalty UI -->
  <div class="loyalty-wrap">
    <input id="loyalty-search" type="search" placeholder="Search name, phone, email, aka, locker, birthday…" autocomplete="off" />
    <ul id="loyalty-list" class="loyalty-list"></ul>
  </div>

  <!-- Profile Modal -->
  <div id="loyalty-modal" class="loyalty-modal" hidden>
    <div class="modal-card">
      <button class="modal-close" onclick="closeLoyaltyModal()">✕</button>
      <div id="loyalty-modal-body"></div>
    </div>
  </div>

  <script>
    let LOYALTY_ROWS = [];
    const FIELDS = {
      LAST: 'Last Name',
      FIRST: 'First Name',
      AKA: 'Nickname “aka”',
      POINTS: 'Points',
      LAST_PURCHASE: 'Last Purchase',
      NOTES: 'Notes',
      LOCKER: 'Locker #',
      REGULAR: 'Regular',
      PHONE: 'Phone',
      EMAIL: 'Email',
      BDAY: 'Birthday',
      YTD: 'YTD spend',
      VISITS90: '90-day visits',
      GIFT: 'Gift card balance',
      RING: 'Ring Pref'
    };

    function val(v){ return (v===undefined||v===null||Number.isNaN(v)) ? '' : String(v); }
    function isLocker(row){ return val(row[FIELDS.LOCKER]).trim() !== ''; }
    function badge(row){ return `<span class="badge ${isLocker(row)?'blue':'orange'}">${isLocker(row)?'Locker':'Regular'}</span>`; }

    function rowLine(row){
      const last = val(row[FIELDS.LAST]);
      const first = val(row[FIELDS.FIRST]);
      const aka = val(row[FIELDS.AKA]);
      const points = val(row[FIELDS.POINTS]);
      const lastPurchase = val(row[FIELDS.LAST_PURCHASE]);
      const notes = val(row[FIELDS.NOTES]);
      return `
        <li class="loyalty-row" onclick='openLoyaltyModal(${JSON.stringify(JSON.stringify(row))})'>
          <div class="truncate"><strong>${last}, ${first}</strong> ${aka?`(<em>${aka}</em>)`:''}</div>
          <div class="truncate">→ Points: <strong>${points||'0'}</strong> • ${lastPurchase||'—'} • ${notes||''}</div>
          ${badge(row)}
        </li>`;
    }

    function render(list){
      document.getElementById('loyalty-list').innerHTML = list.map(rowLine).join('');
    }

    function filterRows(q){
      if(!q) return LOYALTY_ROWS;
      q = q.toLowerCase();
      const keys = [FIELDS.LAST,FIELDS.FIRST,FIELDS.AKA,FIELDS.PHONE,FIELDS.EMAIL,FIELDS.LOCKER,FIELDS.BDAY];
      return LOYALTY_ROWS.filter(r => keys.some(k => val(r[k]).toLowerCase().includes(q)));
    }

    async function fetchLoyalty(){
      const res = await fetch('/.netlify/functions/get-loyalty', { cache:'no-store' });
      const json = await res.json();
      if(!json.ok) throw new Error(json.error || 'Failed to load loyalty data');
      LOYALTY_ROWS = (json.data || []).map(r=>{
        for(const k in r){ if(typeof r[k]==='number' && Number.isNaN(r[k])) r[k]=null; }
        return r;
      });
      render(LOYALTY_ROWS);
    }

    function setupSearch(){
      document.getElementById('loyalty-search').addEventListener('input', (e)=>{
        render(filterRows(e.target.value));
      });
    }

    function openLoyaltyModal(rowJson){
      const row = JSON.parse(rowJson);
      const el = document.getElementById('loyalty-modal-body');
      el.innerHTML = `
        <h3>${val(row[FIELDS.FIRST])} ${val(row[FIELDS.LAST])} ${badge(row)}</h3>
        <div class="kv">
          <b>AKA</b><div>${val(row[FIELDS.AKA])||'—'}</div>
          <b>Points</b><div>${val(row[FIELDS.POINTS])||'0'}</div>
          <b>Last Purchase</b><div>${val(row[FIELDS.LAST_PURCHASE])||'—'}</div>
          <b>YTD Spend</b><div>${val(row[FIELDS.YTD])||'—'}</div>
          <b>Visits (90d)</b><div>${val(row[FIELDS.VISITS90])||'—'}</div>
          <b>Gift Card</b><div>${val(row[FIELDS.GIFT])||'—'}</div>
          <b>Phone</b><div>${val(row[FIELDS.PHONE])||'—'}</div>
          <b>Email</b><div>${val(row[FIELDS.EMAIL])||'—'}</div>
          <b>Birthday</b><div>${val(row[FIELDS.BDAY])||'—'}</div>
          <b>Ring Pref</b><div>${val(row[FIELDS.RING])||'—'}</div>
          <b>Locker #</b><div>${val(row[FIELDS.LOCKER])||'—'}</div>
          <b>Notes</b><div>${val(row[FIELDS.NOTES])||'—'}</div>
        </div>
      `;
      document.getElementById('loyalty-modal').hidden = false;
    }

    function closeLoyaltyModal(){ document.getElementById('loyalty-modal').hidden = true; }
    window.closeLoyaltyModal = closeLoyaltyModal;

    document.addEventListener('DOMContentLoaded', async () => {
      setupSearch();
      try { await fetchLoyalty(); }
      catch (e) { console.error(e); document.getElementById('loyalty-list').innerHTML = '<li>Failed to load loyalty data.</li>'; }
    });
  </script>
</body>
</html>
