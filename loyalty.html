<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Loyalty</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:0; background:#f9f9f9; }
    .loyalty-wrap { padding:12px; }
    #loyalty-search { width:100%; padding:10px 12px; border-radius:8px; border:1px solid #ddd; }
    .loyalty-list { list-style:none; margin:12px 0 0; padding:0; }
    .loyalty-row { display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid #eee; cursor:pointer; background:#fff; }
    .loyalty-row:hover { background:#fafafa; }
    .badge { font-size:12px; padding:2px 8px; border-radius:999px; color:#fff; }
    .badge.blue { background:#2b6cb0; }   /* locker */
    .badge.orange { background:#dd6b20; } /* regular */
    .truncate { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:52vw; }

    /* Modal */
    .loyalty-modal { position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.4); }
    .loyalty-modal[open] { display:grid; }
    .modal-card { width:min(680px,92vw); background:#fff; border-radius:12px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.2); }
    .modal-head { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .modal-close { border:0; background:transparent; font-size:18px; cursor:pointer; }
    .kv { display:grid; grid-template-columns:140px 1fr; gap:6px 12px; margin:12px 0; }
    .kv b { color:#444; }
    .row { display:flex; gap:8px; align-items:center; }
    .btn { appearance:none; border:1px solid #ddd; background:#111; color:#fff; padding:8px 12px; border-radius:8px; cursor:pointer; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    input[type="number"] { width:120px; padding:6px 8px; border:1px solid #ccc; border-radius:8px; }
    .note { font-size:12px; color:#666; }
    .toast { position:fixed; left:50%; transform:translateX(-50%); bottom:18px; background:#111; color:#fff; padding:10px 14px; border-radius:8px; display:none; }
    .toast.show { display:block; }
  </style>
</head>
<body>

  <div class="loyalty-wrap">
    <input id="loyalty-search" type="search" placeholder="Search name, phone, email, aka, locker, birthday…" autocomplete="off" />
    <ul id="loyalty-list" class="loyalty-list"></ul>
  </div>

  <!-- Profile Modal -->
  <dialog id="loyalty-modal" class="loyalty-modal">
    <div class="modal-card">
      <div class="modal-head">
        <h3 id="modal-title" style="margin:0"></h3>
        <button class="modal-close" onclick="closeLoyaltyModal()">✕</button>
      </div>
      <div class="kv" id="loyalty-modal-body"></div>

      <div class="row" style="margin-top:8px;">
        <label for="points-input"><b>Points</b></label>
        <input id="points-input" type="number" min="0" step="1" />
        <button class="btn" id="save-points-btn" onclick="savePoints()">Save Points</button>
        <span class="note" id="save-status"></span>
      </div>
    </div>
  </dialog>

  <div id="toast" class="toast"></div>

  <script>
    let LOYALTY_ROWS = [];
    let CURRENT = null; // currently opened member

    const FIELDS = {
      LAST: 'Last Name',
      FIRST: 'First Name',
      AKA: 'Nickname “aka”',
      POINTS: 'Points',
      LAST_PURCHASE: 'Last Purchase',
      NOTES: 'Notes',
      LOCKER: 'Locker #',
      REGULAR: 'Regular',
      PHONE: 'Phone',
      EMAIL: 'Email',
      BDAY: 'Birthday',
      YTD: 'YTD spend',
      VISITS90: '90-day visits',
      GIFT: 'Gift card balance',
      RING: 'Ring Pref'
    };

    function val(v){ return (v===undefined||v===null||Number.isNaN(v)) ? '' : String(v); }
    function isLocker(row){ return val(row[FIELDS.LOCKER]).trim() !== ''; }
    function badge(row){ return `<span class="badge ${isLocker(row)?'blue':'orange'}">${isLocker(row)?'Locker':'Regular'}</span>`; }

    function rowLine(row){
      const last = val(row[FIELDS.LAST]);
      const first = val(row[FIELDS.FIRST]);
      const aka = val(row[FIELDS.AKA]);
      const points = val(row[FIELDS.POINTS]);
      const lastPurchase = val(row[FIELDS.LAST_PURCHASE]);
      const notes = val(row[FIELDS.NOTES]);
      return `
        <li class="loyalty-row" onclick='openLoyaltyModal(${JSON.stringify(JSON.stringify(row))})'>
          <div class="truncate"><strong>${last}, ${first}</strong> ${aka?`(<em>${aka}</em>)`:''}</div>
          <div class="truncate">→ Points: <strong>${points||'0'}</strong> • ${lastPurchase||'—'} • ${notes||''}</div>
          ${badge(row)}
        </li>`;
    }

    function render(list){
      document.getElementById('loyalty-list').innerHTML = list.map(rowLine).join('');
    }

    function filterRows(q){
      if(!q) return LOYALTY_ROWS;
      q = q.toLowerCase();
      const keys = [FIELDS.LAST,FIELDS.FIRST,FIELDS.AKA,FIELDS.PHONE,FIELDS.EMAIL,FIELDS.LOCKER,FIELDS.BDAY];
      return LOYALTY_ROWS.filter(r => keys.some(k => val(r[k]).toLowerCase().includes(q)));
    }

    async function fetchLoyalty(){
      const res = await fetch('/.netlify/functions/get-loyalty', { cache:'no-store' });
      const json = await res.json();
      if(!json.ok) throw new Error(json.error || 'Failed to load loyalty data');
      LOYALTY_ROWS = (json.data || []).map(r=>{
        for(const k in r){ if(typeof r[k]==='number' && Number.isNaN(r[k])) r[k]=null; }
        return r;
      });
      render(LOYALTY_ROWS);
    }

    function setupSearch(){
      document.getElementById('loyalty-search').addEventListener('input', (e)=>{
        render(filterRows(e.target.value));
      });
    }

    function openLoyaltyModal(rowJson){
      const row = JSON.parse(rowJson);
      CURRENT = row; // cache for save

      const title = `${val(row[FIELDS.FIRST])} ${val(row[FIELDS.LAST])} ${isLocker(row) ? '— Locker' : '— Regular'}`;
      document.getElementById('modal-title').innerHTML = title;

      const el = document.getElementById('loyalty-modal-body');
      el.innerHTML = `
        <b>AKA</b><div>${val(row[FIELDS.AKA])||'—'}</div>
        <b>Last Purchase</b><div>${val(row[FIELDS.LAST_PURCHASE])||'—'}</div>
        <b>YTD Spend</b><div>${val(row[FIELDS.YTD])||'—'}</div>
        <b>Visits (90d)</b><div>${val(row[FIELDS.VISITS90])||'—'}</div>
        <b>Gift Card</b><div>${val(row[FIELDS.GIFT])||'—'}</div>
        <b>Phone</b><div>${val(row[FIELDS.PHONE])||'—'}</div>
        <b>Email</b><div>${val(row[FIELDS.EMAIL])||'—'}</div>
        <b>Birthday</b><div>${val(row[FIELDS.BDAY])||'—'}</div>
        <b>Ring Pref</b><div>${val(row[FIELDS.RING])||'—'}</div>
        <b>Locker #</b><div>${val(row[FIELDS.LOCKER])||'—'}</div>
        <b>Notes</b><div>${val(row[FIELDS.NOTES])||'—'}</div>
      `;

      document.getElementById('points-input').value = Number(val(row[FIELDS.POINTS])) || 0;
      document.getElementById('save-status').textContent = '';
      document.getElementById('loyalty-modal').setAttribute('open','');
    }

    function closeLoyaltyModal(){
      document.getElementById('loyalty-modal').removeAttribute('open');
    }
    window.closeLoyaltyModal = closeLoyaltyModal;

    async function savePoints(){
      const btn = document.getElementById('save-points-btn');
      const status = document.getElementById('save-status');
      const toast = document.getElementById('toast');
      btn.disabled = true; status.textContent = 'Saving…';

      try {
        const points = Number(document.getElementById('points-input').value || 0);
        const body = {
          // prefer email if present; fallback to name (+ aka)
          email: val(CURRENT[FIELDS.EMAIL]) || undefined,
          firstName: val(CURRENT[FIELDS.FIRST]) || undefined,
          lastName: val(CURRENT[FIELDS.LAST]) || undefined,
          aka: val(CURRENT[FIELDS.AKA]) || undefined,
          points
        };

        const res = await fetch('/.netlify/functions/update-points', {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify(body)
        });
        const json = await res.json();
        if (!json.ok) throw new Error(json.error || 'Update failed');

        // Update local cache + re-render
        if (CURRENT) CURRENT[FIELDS.POINTS] = points;
        const matchIdx = LOYALTY_ROWS.findIndex(r => {
          const email = (r[FIELDS.EMAIL] || '').toString().trim().toLowerCase();
          const currEmail = (CURRENT[FIELDS.EMAIL] || '').toString().trim().toLowerCase();
          if (currEmail && email === currEmail) return true;
          return (r[FIELDS.FIRST]||'').toString().trim().toLowerCase() === (CURRENT[FIELDS.FIRST]||'').toString().trim().toLowerCase()
              && (r[FIELDS.LAST]||'').toString().trim().toLowerCase() === (CURRENT[FIELDS.LAST]||'').toString().trim().toLowerCase();
        });
        if (matchIdx >= 0) LOYALTY_ROWS[matchIdx][FIELDS.POINTS] = points;
        render(LOYALTY_ROWS);

        status.textContent = 'Saved';
        toast.textContent = 'Points updated';
        toast.classList.add('show');
        setTimeout(()=>toast.classList.remove('show'), 1400);
      } catch (e) {
        status.textContent = 'Error: ' + e.message;
      } finally {
        btn.disabled = false;
      }
    }
    window.savePoints = savePoints;

    // Boot
    document.addEventListener('DOMContentLoaded', async () => {
      try { await fetchLoyalty(); } catch (e) {
        console.error(e);
        document.getElementById('loyalty-list').innerHTML = '<li>Failed to load loyalty data.</li>';
      }
      document.getElementById('loyalty-search').addEventListener('input', (e)=>{
        render(filterRows(e.target.value));
      });
    });
  </script>
</body>
</html>
