<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Loyalty</title>
<style>
  :root {
    --bg: #f6f7fb;
    --card: #ffffff;
    --text: #111827;
    --muted: #6b7280;
    --blue: #1769ff;
    --row-alt: #f9fafb;
  }
  html, body { margin:0; padding:0; background:var(--bg); color:var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
  .wrap { max-width: 980px; margin: 24px auto; padding: 0 16px; }
  .search { width:100%; box-sizing:border-box; padding:12px 14px; border:1px solid #e5e7eb; border-radius:12px; font-size:16px; background:#fff; }
  .chips { display:flex; gap:12px; margin:14px 0 18px; }
  .chip { display:flex; align-items:center; gap:10px; padding:10px 14px; border-radius:12px; background:#eef2ff; color:#111; cursor:pointer; user-select:none; }
  .chip .dot { width:14px; height:14px; border-radius:4px; }
  .chip .dot.blue { background:#1769ff; }
  .chip .dot.orange { background:#ef6c00; }
  .chip.active { outline:2px solid #1113; }
  .card { background:var(--card); border-radius:16px; overflow:hidden; box-shadow: 0 6px 18px rgba(16,24,40,0.04); }
  table { width:100%; border-collapse:collapse; }
  thead th { text-align:left; font-weight:700; font-size:14px; color:#111; background:#f3f4f6; padding:12px 14px; }
  tbody td { padding:12px 14px; border-top:1px solid #f1f5f9; vertical-align:middle; }
  tbody tr:nth-child(even):not(.locker) { background:var(--row-alt); }
  tbody tr.locker { background: #1769ff; color:#fff; }
  .name { display:flex; align-items:center; gap:10px; }
  .badge { width:22px; height:22px; display:inline-block; }
  .last { font-weight:800; display:block; }
  .first { font-weight:400; display:block; margin-top:2px; color:inherit; opacity:0.9; }
  .muted { color:var(--muted); }
  @media (max-width: 640px){
    thead { display:none; }
    tbody td { display:block; padding:10px 14px; }
    tbody tr { border-bottom:1px solid #e5e7eb; }
    tbody td[data-h]::before { content: attr(data-h); display:block; font-size:12px; color:var(--muted); margin-bottom:4px; }
  }
</style>
</head>
<body>
  <div class="wrap">
    <input id="q" class="search" placeholder="Search" autocomplete="off" />

    <div class="chips">
      <div class="chip" data-filter="locker">
        <span class="dot blue"></span> <strong>Locker members</strong>
      </div>
      <div class="chip" data-filter="regular">
        <span class="dot orange"></span> <strong>Regulars</strong>
      </div>
    </div>

    <div class="card">
      <table>
        <thead>
          <tr>
            <th></th>
            <th>Name</th>
            <th>Pts</th>
            <th>Last Visit</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </div>

<script>
/* ---------- Small CSV parser (handles quotes) ---------- */
function parseCSV(text){
  const rows=[]; let i=0, f='', r=[], q=false;
  const pf=()=>{ r.push(f); f=''; }; const pr=()=>{ rows.push(r); r=[]; };
  while(i<text.length){
    const c=text[i];
    if(q){
      if(c==='"' && text[i+1]==='"'){ f+='"'; i+=2; continue; }
      if(c==='"' ){ q=false; i++; continue; }
      f+=c; i++; continue;
    }
    if(c==='"'){ q=true; i++; continue; }
    if(c===','){ pf(); i++; continue; }
    if(c==='\r'){ i++; continue; }
    if(c==='\n'){ pf(); pr(); i++; continue; }
    f+=c; i++;
  }
  if(f.length||r.length){ pf(); pr(); }
  return rows;
}
function hIndex(headers,name){
  const lc = headers.map(h => (h||'').toString().trim().toLowerCase());
  const key = name.toLowerCase();
  return lc.indexOf(key);
}
function truthy(v){ if(v==null) return false; const s=String(v).trim().toLowerCase(); return ['y','yes','true','1','x'].includes(s); }
function fmtLastVisit(raw){
  const s = (raw||'').trim(); if(!s) return '—';
  const d = new Date(s); if(isNaN(d)) return '—';
  const now = new Date();
  const diffMonths = (now.getFullYear()-d.getFullYear())*12 + (now.getMonth()-d.getMonth());
  if(diffMonths < 6) return `${d.getMonth()+1}/${d.getDate()}`;
  if(diffMonths < 12) return d.toLocaleString('default',{month:'long'});
  if(diffMonths < 24) return 'Year+';
  return `${d.getFullYear()}`;
}
function iconFor(b){ // order of priority: military, responder, locker
  if(b.military) return '/img/military.svg';
  if(b.responder) return '/img/firstresponders.svg';
  if(b.locker)    return '/img/lockermember.svg';
  return '';
}

/* ---------- Load + Render ---------- */
async function load(){
  const res = await fetch('/img/contacts.csv?cachebust=' + Date.now());
  if(!res.ok){ throw new Error('Could not load contacts.csv'); }
  const csv = await res.text();
  const rows = parseCSV(csv);
  if(rows.length < 2) throw new Error('CSV is empty');

  const headers = rows[0].map(h => (h||'').toString().trim());
  const C = {
    locker:         idx('Locker') ?? idx('Locker #'),
    regular:        idx('Regular'),
    military:       idx('Military'),
    responder:      idx('First Responder'),
    rewards:        idx('Rewards'),
    lastName:       idx('Last Name'),
    firstName:      idx('First Name'),
    aka:            idx('Nickname “aka”') ?? idx('Nickname "aka"') ?? idx('aka'),
    lastPurchase:   idx('Last Purchase'),
    email:          idx('Email'),
    phone:          idx('Phone')
  };

  function idx(name){ const i = hIndex(headers, name); return i >= 0 ? i : null; }

  const data = [];
  for(let r=1; r<rows.length; r++){
    const c = rows[r];
    if(!c || c.every(x => (x??'').toString().trim()==='')) continue;

    const badges = {
      locker: truthy(C.locker!=null ? c[C.locker] : ''),
      military: truthy(C.military!=null ? c[C.military] : ''),
      responder: truthy(C.responder!=null ? c[C.responder] : '')
    };

    data.push({
      id: String(r),
      first: C.firstName!=null ? (c[C.firstName]||'').toString().trim() : '',
      last:  C.lastName!=null  ? (c[C.lastName] ||'').toString().trim() : '',
      points: C.rewards!=null  ? Number(c[C.rewards]||0) || 0 : 0,
      lastVisit: fmtLastVisit(C.lastPurchase!=null ? c[C.lastPurchase] : ''),
      badges,
      email: C.email!=null ? c[C.email] : '',
      phone: C.phone!=null ? c[C.phone] : ''
    });
  }

  setupUI(data);
}

function setupUI(all){
  const tbody = document.getElementById('rows');
  const q = document.getElementById('q');
  const chips = document.querySelectorAll('.chip');

  function matchesFilter(rec, mode){
    if(!mode) return true;
    if(mode === 'locker') return rec.badges.locker;
    if(mode === 'regular') return !rec.badges.locker;
    return true;
  }
  function matchesSearch(rec, term){
    if(!term) return true;
    term = term.toLowerCase();
    return (
      rec.first.toLowerCase().includes(term) ||
      rec.last.toLowerCase().includes(term) ||
      rec.email.toLowerCase().includes(term) ||
      rec.phone.toLowerCase().includes(term)
    );
  }
  function render(){
    const term = q.value.trim().toLowerCase();
    const activeChip = document.querySelector('.chip.active');
    const mode = activeChip ? activeChip.getAttribute('data-filter') : '';

    tbody.innerHTML = '';
    const list = all.filter(r => matchesFilter(r, mode) && matchesSearch(r, term));

    for(const r of list){
      const tr = document.createElement('tr');
      if(r.badges.locker) tr.classList.add('locker');

      const icon = iconFor(r.badges);
      tr.innerHTML = `
        <td data-h="">
          ${icon ? `<img class="badge" src="${icon}" alt="">` : ''}
        </td>
        <td data-h="Name">
          <div class="name">
            <div>
              <span class="last">${r.last || '&nbsp;'}</span>
              <span class="first">${r.first || ''}</span>
            </div>
          </div>
        </td>
        <td data-h="Pts">${r.points}</td>
        <td data-h="Last Visit">${r.lastVisit}</td>
      `;
      tbody.appendChild(tr);
    }

    if(list.length === 0){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="4" class="muted">No results</td>`;
      tbody.appendChild(tr);
    }
  }

  q.addEventListener('input', render);
  chips.forEach(ch => {
    ch.addEventListener('click', () => {
      if(ch.classList.contains('active')) {
        ch.classList.remove('active');        // toggle off (show all)
      } else {
        chips.forEach(c => c.classList.remove('active'));
        ch.classList.add('active');
      }
      render();
    });
  });

  render();
}

load().catch(err => {
  document.getElementById('rows').innerHTML =
    `<tr><td colspan="4" style="color:#b91c1c;padding:14px;">Error loading contacts: ${err.message}</td></tr>`;
});
</script>
</body>
</html>
