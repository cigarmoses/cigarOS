// netlify/functions/get-loyalty.js
/* GitHub-only data source:
   - Primary:   /img/contacts.csv  (in your repo)
   - Fallback:  /img/contacts.json (optional)
   No Netlify Blobs. No terminal needed.
*/

function truthy(v) {
  if (v == null) return false;
  const s = String(v).trim().toLowerCase();
  return s === 'y' || s === 'yes' || s === 'true' || s === '1' || s === 'x' || s === '✓';
}

// Tiny CSV parser (handles quotes, commas, newlines)
function parseCSV(text) {
  const rows = []; let i = 0, f = '', r = [], q = false;
  const pf = () => (r.push(f), f = '');
  const pr = () => (rows.push(r), r = []);
  while (i < text.length) {
    const c = text[i];
    if (q) { if (c === '"') { if (text[i + 1] === '"') { f += '"'; i += 2; continue; } q = false; i++; continue; } f += c; i++; continue; }
    if (c === '"') { q = true; i++; continue; }
    if (c === ',') { pf(); i++; continue; }
    if (c === '\r') { i++; continue; }
    if (c === '\n') { pf(); pr(); i++; continue; }
    f += c; i++;
  }
  pf(); if (r.length) pr();
  if (!rows.length) return [];
  const headers = rows[0].map(h => (h || '').trim());
  return rows.slice(1).map(row => {
    const o = {};
    headers.forEach((k, idx) => (o[k] = row[idx] ?? ''));
    return o;
  });
}

// helpers to find fields by common variants
const pick = (o, keys) => { for (const k of keys) if (k in o && String(o[k]).trim() !== '') return o[k]; return ''; };
const findHeader = (o, token) => (Object.keys(o).find(k => k.toLowerCase() === token.toLowerCase()) ||
                                  Object.keys(o).find(k => k.toLowerCase().includes(token.toLowerCase())) || '');

function splitName(s) {
  s = String(s || '').trim();
  if (!s) return { first: '', last: '' };
  if (s.includes(',')) {
    const [last, rest] = s.split(',').map(x => x.trim());
    return { first: rest || '', last: last || '' };
  }
  const p = s.split(/\s+/);
  if (p.length >= 2) return { first: p.slice(0, -1).join(' '), last: p.slice(-1)[0] };
  return { first: '', last: s };
}

function normalizeRecord(raw) {
  let last  = pick(raw, ['Last Name','last_name','Last','LName']);
  let first = pick(raw, ['First Name','first_name','First','FName']);
  const full = pick(raw, ['Name','Full Name','Customer','Client']);

  if (!last)  { const k = findHeader(raw, 'last');  if (k) last  = raw[k]; }
  if (!first) { const k = findHeader(raw, 'first'); if (k) first = raw[k]; }
  if ((!first || !last) && full) { const n = splitName(full); if (!first) first = n.first; if (!last) last = n.last; }

  const aka          = pick(raw, ['Nickname “aka”','Nickname "aka"','aka','AKA','Nick','Nickname']);
  const points       = Number(pick(raw, ['Points','Rewards','Pts','points','rewards'])) || 0;
  const lastPurchase = pick(raw, ['Last Purchase','Last purchase','Last Visit','Last visit','Last','last_purchase','last visit']);
  const lockerVal    = pick(raw, ['Locker #','Locker','Locker Number','Locker#','locker_#']);
  const regular      = pick(raw, ['Regular','regular']);
  const email        = pick(raw, ['Email','email','E-mail']);
  const phone        = pick(raw, ['Phone','phone','Mobile','Cell']);

  const military  = truthy(pick(raw, ['Military','military','Vet','Veteran']));
  const responder = truthy(pick(raw, ['First Responder','Responder','first_responder']));
  const lockerFlg = truthy(lockerVal) || truthy(pick(raw, ['Locker Member','locker_member']));

  return {
    first: String(first || '').trim(),
    last:  String(last  || '').trim(),
    aka:   String(aka   || '').trim(),
    points,
    lastPurchase: String(lastPurchase || '').trim(),
    locker: String(lockerVal || '').trim(),
    regular: String(regular || '').trim(),
    email: String(email || '').trim(),
    phone: String(phone || '').trim(),
    badges: { military, responder, locker: lockerFlg },
    _raw: raw
  };
}

async function loadContactsFromCSV() {
  const url = new URL('../../img/contacts.csv', import.meta.url);
  const res = await fetch(url);
  if (!res.ok) throw new Error('contacts.csv not found in /img');
  const txt = await res.text();
  const rows = parseCSV(txt);
  return rows.map(normalizeRecord);
}

async function loadContactsFromJSONFallback() {
  const url = new URL('../../img/contacts.json', import.meta.url);
  const res = await fetch(url);
  if (!res.ok) return [];
  const arr = await res.json();
  return (Array.isArray(arr) ? arr : []).map(normalizeRecord);
}

export default async () => {
  try {
    let data = [];
    try {
      data = await loadContactsFromCSV();
    } catch {
      data = await loadContactsFromJSONFallback();
    }
    if (!data.length) throw new Error('No contacts found');
    return new Response(JSON.stringify({ ok: true, source: 'repo', data }), {
      headers: { 'content-type': 'application/json' }
    });
  } catch (err) {
    return new Response(JSON.stringify({ ok: false, error: err?.message || 'Unable to load contacts' }), {
      status: 500, headers: { 'content-type': 'application/json' }
    });
  }
};
