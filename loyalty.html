<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Loyalty</title>
<style>
  :root{
    --bg:#f4f6f9; --card:#ffffff; --text:#1a1a1a;
    --line:#e5e7eb; --blue:#2b6cb0; --orange:#dd6b20; --chip-bg:#eef2f7;
    --zebra:#f7f9fc; --muted:#6b7280; --shadow:0 1px 2px rgba(0,0,0,.03), 0 10px 30px rgba(0,0,0,.03);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
  .wrap{max-width:980px;margin:0 auto;padding:18px 14px 28px;}
  .searchbar{position:sticky;top:0;z-index:5;background:var(--bg);padding-bottom:10px;}
  .search{width:100%;height:56px;border-radius:18px;border:1px solid var(--line);
    background:#fff;padding:0 18px;font-size:20px;outline:none;box-shadow:0 1px 0 rgba(0,0,0,.02);}
  .chips{display:flex;gap:16px;margin-top:14px;flex-wrap:wrap}
  .chip{background:var(--chip-bg);border-radius:14px;padding:10px 14px;color:#6b7280;font-weight:600;
    display:flex;align-items:center;gap:10px;user-select:none;cursor:pointer}
  .chip.active{filter:saturate(1.1);background:#e9eef7;color:#1f2937}
  .dot{width:18px;height:18px;border-radius:6px}
  .dot.blue{background:var(--blue)} .dot.orange{background:var(--orange)}

  .card{margin-top:14px;background:var(--card);border-radius:18px;padding:12px;box-shadow:var(--shadow);}
  .thead{display:grid;grid-template-columns:.35fr 1.2fr .5fr .7fr;gap:12px;color:#374151;
    font-weight:800;font-size:22px;padding:8px 12px 14px 12px;}
  .rows{border-top:1px solid var(--line)}
  .row{display:grid;grid-template-columns:.35fr 1.2fr .5fr .7fr;gap:12px;padding:14px 12px;
    border-bottom:1px solid var(--line);align-items:center}
  .row:last-child{border-bottom:0}

  /* Default zebra */
  .row.neutral{background:#fff}
  .row.neutral:nth-child(odd){background:var(--zebra)}
  /* Locker rows stay blue */
  .row.locker{background:var(--blue);color:#fff;border-bottom-color:rgba(255,255,255,.28)}
  .row.locker .name .last,
  .row.locker .lastCell { color:#fff; }

  .name{display:flex;flex-direction:column;line-height:1.05;}
  .name .last{font-weight:800;font-size:22px}
  .name .first{font-weight:500;font-size:22px}
  .pts{font-weight:800;font-size:20px}
  .lastCell{font-weight:700;font-size:20px;color:#6b7280}

  /* Badge cell */
  .badges{display:flex;gap:8px;align-items:center}
  .badge{width:28px;height:28px;display:inline-flex;align-items:center;justify-content:center;border-radius:6px;
    background:#f1f5f9;border:1px solid #e2e8f0}
  .row.locker .badge{background:rgba(255,255,255,.18);border-color:rgba(255,255,255,.35)}

  /* Suggest dropdown */
  .suggest{position:relative;margin-top:8px}
  .suggest-list{position:absolute;left:0;right:0;top:0;background:#fff;border:1px solid var(--line);
    border-radius:12px;max-height:260px;overflow:auto;box-shadow:var(--shadow);display:none;z-index:10}
  .suggest-item{padding:10px 12px;border-bottom:1px solid var(--line);cursor:pointer}
  .suggest-item:last-child{border-bottom:0}
  .suggest-item:hover{background:#f8fafc}
  @media (max-width:640px){
    .thead{font-size:18px}
    .name .last,.name .first{font-size:20px}
    .pts,.lastCell{font-size:18px}
    .row{padding:12px}
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="searchbar">
      <input id="q" class="search" type="search" placeholder="Search" />
      <div class="chips">
        <div id="chip-locker" class="chip active" role="button" tabindex="0">
          <span class="dot blue"></span> Locker members
        </div>
        <div id="chip-regular" class="chip active" role="button" tabindex="0">
          <span class="dot orange"></span> Regulars
        </div>
      </div>

      <!-- Suggestions dropdown -->
      <div class="suggest">
        <div id="suggest-list" class="suggest-list"></div>
      </div>
    </div>

    <div class="card">
      <div class="thead">
        <div></div>
        <div>Name</div>
        <div>Pts</div>
        <div>Last Visit</div>
      </div>
      <div id="rows" class="rows"></div>
    </div>
  </div>

<script>
  // Inline SVG icons
  const ICONS = {
    locker: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none"><rect x="3" y="4" width="18" height="16" rx="2" stroke="currentColor" stroke-width="2"/><path d="M7 4v16M12 4v16M17 4v16" stroke="currentColor" stroke-width="2"/></svg>`,
    military: `<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l9 4v6c0 5.25-4.5 9.75-9 10-4.5-.25-9-4.75-9-10V6l9-4zm0 5l-5 2v3c0 3.5 2.9 6.5 5 6.7 2.1-.2 5-3.2 5-6.7V9l-5-2z"/></svg>`,
    responder: `<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M11 2h2v7h7v2h-7v7h-2v-7H4V9h7V2z"/></svg>`
  };

  const MONTHS = [
    'January','February','March','April','May','June',
    'July','August','September','October','November','December'
  ];

  let ALL = [];
  let filters = { locker: true, regular: true };
  const $ = s => document.querySelector(s);
  const rowsEl = $('#rows');
  const chipLocker = $('#chip-locker');
  const chipRegular = $('#chip-regular');
  const q = $('#q');
  const suggestList = $('#suggest-list');

  chipLocker.addEventListener('click', ()=>{ filters.locker=!filters.locker; chipLocker.classList.toggle('active',filters.locker); render(); showSuggestions(); });
  chipRegular.addEventListener('click', ()=>{ filters.regular=!filters.regular; chipRegular.classList.toggle('active',filters.regular); render(); showSuggestions(); });
  q.addEventListener('input', ()=>{ render(); showSuggestions(); });
  q.addEventListener('focus', showSuggestions);
  document.addEventListener('click', (e)=>{ if (!e.target.closest('.suggest') && e.target !== q) suggestList.style.display='none'; });

  const isLocker = r => (r.locker || '').trim() !== '' || (r.badges && r.badges.locker);
  const isRegular = r => (r.regular || '').trim() !== '';
  const variant = r => isLocker(r) ? 'locker' : 'neutral';

  const fmtPts = n => {
    const num = Number(n||0);
    if (!isFinite(num)) return '0';
    if (Math.abs(num) >= 1000) return (num/1000).toFixed(num%1000===0?0:1)+'k';
    return String(num);
  };

  // Parse lastPurchase string to Date (best-effort)
  function parseMaybeDate(s){
    if (!s) return null;
    const t = String(s).trim();
    // common: M/D/YY or M/D/YYYY
    const md = t.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
    if (md) {
      let y = md[3].length===2 ? (2000 + parseInt(md[3],10)) : parseInt(md[3],10);
      return new Date(y, parseInt(md[1],10)-1, parseInt(md[2],10));
    }
    // Year only
    const y = t.match(/^\d{4}$/);
    if (y) return new Date(parseInt(t,10), 0, 1);
    // Fallback to Date parser for things like "Sep 2024"
    const dt = new Date(t);
    return isNaN(dt.getTime()) ? null : dt;
  }

  // UPDATED: 6–12 months shows MONTH NAME
  function fmtLastVisit(raw){
    const d = parseMaybeDate(raw);
    if (!d) return '—';
    const now = new Date();
    const ms = now - d;
    const months = ms / (1000*60*60*24*30.4375); // avg month
    const y = d.getFullYear();

    // over two years and not 2025 or 2024 => year only
    if (months >= 24 && y !== 2025 && y !== 2024) return String(y);

    if (months >= 12) return 'Year +';

    if (months >= 6) {
      // month name (e.g., "September")
      return MONTHS[d.getMonth()];
    }
    // within 6 months => M/D
    return (d.getMonth()+1) + '/' + d.getDate();
  }

  function badgeHTML(r){
    const arr = [];
    if (r.badges?.military)   arr.push(`<span class="badge" title="Military">${ICONS.military}</span>`);
    if (r.badges?.responder)  arr.push(`<span class="badge" title="First Responder">${ICONS.responder}</span>`);
    if (isLocker(r))          arr.push(`<span class="badge" title="Locker">${ICONS.locker}</span>`);
    return arr.join('');
  }

  function rowHTML(r){
    const v = variant(r);
    return `
      <div class="row ${v}">
        <div class="badges">${badgeHTML(r)}</div>
        <div class="name">
          <div class="last">${r.last || ''}</div>
          <div class="first">${r.first || ''}</div>
        </div>
        <div class="pts">${fmtPts(r.points)}</div>
        <div class="lastCell">${fmtLastVisit(r.lastPurchase)}</div>
      </div>
    `;
  }

  function currentFiltered(){
    const query = (q.value||'').toLowerCase();
    return ALL.filter(r=>{
      if (isLocker(r) && !filters.locker) return false;
      if (isRegular(r) && !filters.regular) return false;
      if (!query) return true;
      const hay = [r.first, r.last, r.email, r.aka, r.phone, r.locker, r.regular]
        .map(v => (v||'').toLowerCase());
      return hay.some(s => s.includes(query));
    });
  }

  function render(){
    const list = currentFiltered();
    rowsEl.innerHTML = list.map(rowHTML).join('') || `<div style="padding:18px;color:#6b7280;">No results</div>`;
  }

  function showSuggestions(){
    const list = currentFiltered().slice(0, 20); // top 20
    if (!q.matches(':focus') && !q.value) { suggestList.style.display='none'; return; }
    suggestList.innerHTML = list.map(r => `
      <div class="suggest-item" data-name="${(r.last || '') + ', ' + (r.first || '')}">
        ${r.last || ''}, ${r.first || ''} ${isLocker(r)?'· Locker':''}
      </div>
    `).join('') || `<div class="suggest-item">No matches</div>`;
    suggestList.style.display = 'block';
  }

  suggestList.addEventListener('click', (e)=>{
    const item = e.target.closest('.suggest-item');
    if (!item) return;
    q.value = item.getAttribute('data-name');
    render();
    suggestList.style.display='none';
    q.blur();
  });

  async function boot(){
    try{
      const res = await fetch('/.netlify/functions/get-loyalty', { cache:'no-store' });
      const json = await res.json();
      if(!json.ok) throw new Error(json.error || 'Load failed');
      ALL = Array.isArray(json.data) ? json.data : [];
      render();
      showSuggestions();
    }catch(e){
      rowsEl.innerHTML = `<div style="padding:18px;color:#b91c1c;">Error loading loyalty data: ${e.message}</div>`;
      console.error(e);
    }
  }
  document.addEventListener('DOMContentLoaded', boot);
</script>
</body>
</html>
