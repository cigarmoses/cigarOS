<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Loyalty</title>
<style>
  :root{
    --bg:#f6f7fb; --card:#fff; --text:#111827; --muted:#6b7280;
    --blue:#1769ff; --orange:#ef6c00; --row:#f9fafb; --border:#e5e7eb;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);
       font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif}
  .wrap{max-width:980px;margin:22px auto;padding:0 16px}

  /* Controls */
  .controls{display:grid;grid-template-columns:1fr auto auto;gap:12px;align-items:center}
  .search{width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:12px;background:#fff;font-size:16px}
  .chip{display:inline-flex;align-items:center;gap:10px;padding:10px 14px;border-radius:12px;background:#eef2ff;border:1px solid #e6e9f5;cursor:pointer;user-select:none}
  .chip .dot{width:14px;height:14px;border-radius:4px}
  .dot.blue{background:var(--blue)} .dot.orange{background:var(--orange)}
  .chip.active{outline:2px solid #1112}

  /* Table-like list */
  .card{margin-top:10px;background:var(--card);border-radius:16px;box-shadow:0 6px 18px rgba(16,24,40,.04)}
  .labels,.row{
    display:grid;
    grid-template-columns: 26px 1fr 56px 86px; /* icon | name | pts | last visit */
    align-items:center;
    gap:10px;
    padding:12px 14px;
  }
  .labels{position:sticky;top:0;z-index:1;background:#f3f4f6;border-bottom:1px solid var(--border);
          border-top-left-radius:16px;border-top-right-radius:16px}
  .labels div{font-size:14px;font-weight:700}
  .rows{border-bottom-left-radius:16px;border-bottom-right-radius:16px;overflow:hidden}
  .row{border-top:1px solid var(--border);background:#fff}
  .row:nth-child(even):not(.locker):not(.regular){background:var(--row)}
  .row.locker{background:var(--blue);color:#fff}
  .row.regular{background:var(--orange);color:#fff}

  .badge{width:22px;height:22px}
  .nameblock{line-height:1.05}
  .last-name{display:block;font-weight:800}
  .first-name{display:block;font-weight:400;opacity:.95;margin-top:2px}
  .pts,.last{justify-self:center;font-weight:700}
  .last{white-space:nowrap}

  @media (max-width:410px){
    .labels,.row{grid-template-columns: 22px 1fr 50px 74px}
  }

  .toast{margin-top:14px;color:#b91c1c;background:#fee2e2;border:1px solid #fecaca;padding:10px 12px;border-radius:12px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="controls">
      <input id="q" class="search" placeholder="Search" autocomplete="off" />
      <div id="chip-locker" class="chip" data-filter="locker"><span class="dot blue"></span><strong>Locker members</strong></div>
      <div id="chip-regular" class="chip" data-filter="regular"><span class="dot orange"></span><strong>Regulars</strong></div>
    </div>

    <div id="error" class="toast" style="display:none"></div>

    <div class="card">
      <div class="labels">
        <div></div>
        <div>Name</div>
        <div class="pts">Pts</div>
        <div class="last">Last Visit</div>
      </div>
      <div id="rows" class="rows"></div>
    </div>
  </div>

<script>
/* ---------------- CSV parsing ---------------- */
function parseCSV(text){
  const lines = text.replace(/\r/g,'').split('\n').filter(Boolean);
  if (!lines.length) return [];
  const headers = lines.shift().split(',').map(h => h.trim());
  return lines.map(line => {
    const cells = []; let cur='', q=false;
    for (let i=0;i<line.length;i++){
      const ch=line[i];
      if (ch === '"'){ q=!q; continue; }
      if (ch === ',' && !q){ cells.push(cur); cur=''; continue; }
      cur += ch;
    }
    cells.push(cur);
    const obj = {};
    headers.forEach((h,i)=> obj[h]= (cells[i]??'').trim());
    return obj;
  });
}

/* ----------- helpers ----------- */
function normalizeKey(k){ return String(k).toLowerCase().replace(/[^a-z0-9]+/g,''); }
function makeKeyMap(row){
  const m={};
  for (const k in row) m[normalizeKey(k)] = row[k];
  return m;
}
function getAny(map, keys){
  for (const k of keys){
    const v = map[normalizeKey(k)];
    if (v != null && v !== '') return v;
  }
  return '';
}
function truthyFlag(v){
  const s = String(v||'').trim();
  if (!s) return false;
  return /^(y|yes|x|1|true)$/i.test(s);
}

/* ------------- Last visit formatting rules ------------- */
function formatLastVisit(raw){
  if (!raw) return '—';
  const dt = new Date(raw.replace(/T/,' ').replace(/-/g,'/'));
  if (isNaN(dt)) return '—';
  const now = new Date();
  const months = (now.getFullYear()-dt.getFullYear())*12 + (now.getMonth()-dt.getMonth());
  if (months < 6)  return `${dt.getMonth()+1}/${dt.getDate()}`;
  if (months < 12) return dt.toLocaleString('en-US',{month:'long'});
  const years = now.getFullYear()-dt.getFullYear();
  if (years > 2 && ![2024,2025].includes(dt.getFullYear())) return String(dt.getFullYear());
  return 'Year+';
}

/* ---------------- normalize one CSV row ---------------- */
function normalizeRow(raw){
  const map = makeKeyMap(raw);

  const lastName   = getAny(map,['Last Name','Last']);
  const firstName  = getAny(map,['First Name','First']);
  const pointsRaw  = getAny(map,['Rewards','Points']) || '0';
  const lastPurch  = getAny(map,['Last Purchase','LastPurchase','Last Purchase Date']);

  // Locker logic: ANY digit in locker column
  const lockerVal = getAny(map,['Locker #','Locker#','Locker','Locker Number','Locker No','Locker Id','LockerID']);
  const isLocker  = /\d/.test(String(lockerVal));

  const regVal    = getAny(map,['Regular']);
  const isRegular = String(regVal).trim() !== '';

  const isMilitary   = truthyFlag(getAny(map,['Military']));
  const isResponder  = truthyFlag(getAny(map,['First Responder','First_Responder','Responder']));

  return {
    lastName, firstName,
    points: Number(pointsRaw) || 0,
    last: formatLastVisit(lastPurch),
    flags: { locker: isLocker, regular: isRegular, military: isMilitary, responder: isResponder }
  };
}

/* ---------------- render ---------------- */
const state = { all:[], view:[], filter:null, q:'' };

function render(){
  const rowsEl = document.getElementById('rows');
  rowsEl.innerHTML = '';
  const q = state.q.trim().toLowerCase();
  const filter = state.filter;

  const list = state.view.filter(p=>{
    const passSearch = !q || (`${p.lastName} ${p.firstName}`).toLowerCase().includes(q);
    const passFilter = !filter || p.flags[filter];
    return passSearch && passFilter;
  });

  for (const p of list){
    const row = document.createElement('div');
    row.className = 'row' + (p.flags.locker ? ' locker' : p.flags.regular ? ' regular' : '');

    // badge priority: military > responder > locker
    const badge = document.createElement('img');
    badge.className = 'badge';
    if (p.flags.military)        badge.src = '/img/military.svg';
    else if (p.flags.responder)  badge.src = '/img/firstresponders.svg';
    else if (p.flags.locker)     badge.src = '/img/locker.svg';  // corrected
    else                         badge.style.opacity = 0;

    const name = document.createElement('div');
    name.className = 'nameblock';
    name.innerHTML = `<span class="last-name">${p.lastName||''}</span><span class="first-name">${p.firstName||''}</span>`;

    const pts = document.createElement('div');
    pts.className = 'pts';
    pts.textContent = p.points || 0;

    const last = document.createElement('div');
    last.className = 'last';
    last.textContent = p.last || '—';

    row.appendChild(badge);
    row.appendChild(name);
    row.appendChild(pts);
    row.appendChild(last);
    rowsEl.appendChild(row);
  }
}

/* ---------------- events ---------------- */
document.getElementById('q').addEventListener('input', e=>{
  state.q = e.target.value;
  render();
});
for (const id of ['chip-locker','chip-regular']){
  const el = document.getElementById(id);
  el.addEventListener('click', ()=>{
    const key = el.dataset.filter;
    if (state.filter === key){ state.filter = null; el.classList.remove('active'); }
    else{
      state.filter = key;
      document.getElementById('chip-locker').classList.toggle('active', key==='locker');
      document.getElementById('chip-regular').classList.toggle('active', key==='regular');
    }
    render();
  });
}

/* ---------------- load CSV from repo ---------------- */
(async function load(){
  try{
    const res = await fetch('/img/contacts.csv',{cache:'no-store'});
    if (!res.ok) throw new Error('Could not load /img/contacts.csv');
    const csv = await res.text();
    const rows = parseCSV(csv);
    const normalized = rows.map(normalizeRow);
    normalized.sort((a,b)=> (a.lastName||'').localeCompare(b.lastName||'') || (a.firstName||'').localeCompare(b.firstName||''));
    state.all = state.view = normalized;
    render();
  }catch(err){
    const box = document.getElementById('error');
    box.style.display='block';
    box.textContent = `Error loading contacts: ${err.message}`;
  }
})();
</script>
</body>
</html>
