<!doctype html><meta charset="utf-8"/>
<title>Import & Save Inventory</title>
<style>
  body{font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif;max-width:800px;margin:24px auto;padding:0 16px}
  input,button,textarea{font:inherit}
  .row{margin:12px 0}
  textarea{width:100%;height:240px}
  code{background:#f4f5f7;padding:2px 6px;border-radius:4px}
</style>

<h1>Import & Save Inventory</h1>

<div class="row">
  <label>ADMIN_TOKEN: <input id="token" type="password" placeholder="your secret" style="width:280px"></label>
</div>

<div class="row">
  <input id="file" type="file" accept=".csv,.json">
  <button id="load">Load file</button>
</div>

<div class="row">
  <p>Preview / edit JSON below, then click <b>Save to server</b>.</p>
  <textarea id="out" placeholder='[]'></textarea>
</div>

<div class="row">
  <button id="save">Save to server</button>
  <span id="msg"></span>
</div>

<script>
const $ = (s)=>document.querySelector(s);

function csvToJson(csv){
  const lines = csv.replace(/\r/g,'').split('\n').filter(Boolean);
  const headers = lines.shift().split(',').map(h=>h.trim());
  return JSON.stringify(lines.map(line=>{
    const cells = line.split(',');
    const obj = {};
    headers.forEach((h,i)=>obj[h]=cells[i]?.trim() ?? '');
    return obj;
  }), null, 2);
}

$('#load').onclick = async () => {
  const f = $('#file').files[0];
  if(!f){ alert('Choose a CSV or JSON file'); return; }
  const txt = await f.text();
  if(f.name.toLowerCase().endsWith('.csv')) $('#out').value = csvToJson(txt);
  else $('#out').value = txt;
};

$('#save').onclick = async () => {
  const token = $('#token').value.trim();
  if(!token){ alert('Enter ADMIN_TOKEN'); return; }

  let json;
  try { json = JSON.parse($('#out').value); }
  catch{ alert('JSON is invalid'); return; }

  // (optional) verify token
  const v = await fetch('/.netlify/functions/verify-token', { headers: { 'x-admin-token': token }});
  if(!v.ok){ alert('Token invalid'); return; }

  const r = await fetch('/.netlify/functions/save-data', {
    method:'POST',
    headers:{ 'content-type':'application/json', 'x-admin-token': token },
    body: JSON.stringify({ inventory: json })
  });
  if(r.ok) $('#msg').textContent = 'Saved!';
  else $('#msg').textContent = 'Failed to save';
};
</script>
