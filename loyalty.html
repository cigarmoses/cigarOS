<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Loyalty — CigarOS</title>
<link rel="icon" href="/img/favicon.svg"/>
<style>
  :root{
    --bg:#0f1115; --panel:#141821; --card:#1a2030; --text:#e8eefc; --muted:#9fb0d0;
    --chip:#0d1220; --border:#273555; --shadow:0 10px 26px rgba(0,0,0,.35);
    --blue:#2563eb; --blueSoft:#103063; --orange:#ea580c; --orangeSoft:#441d06;
    --radius:16px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:15px/1.5 system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif}
  header{position:sticky;top:0;z-index:20;display:flex;gap:12px;align-items:center;background:rgba(15,17,21,.7);backdrop-filter:blur(8px);padding:12px}
  header a{color:var(--muted);text-decoration:none}
  h1{font-size:18px;margin:0}
  .wrap{padding:12px}
  .search{display:flex;gap:10px}
  .search input{flex:1;appearance:none;border:1px solid var(--border);background:#111728;color:var(--text);border-radius:14px;padding:12px 14px;font-size:15px}
  .chips{display:flex;gap:8px;margin-top:8px}
  .chip{display:flex;align-items:center;gap:8px;padding:7px 10px;border-radius:999px;border:1px solid var(--border);background:var(--chip);color:var(--muted);font-size:13px;cursor:pointer}
  .chip input{accent-color:#5ea0ff}
  .list{margin-top:12px;background:var(--panel);border-radius:20px;overflow:hidden;box-shadow:var(--shadow)}
  /* grid:   [name] [pts] [last] [notes] */
  .thead,.row{display:grid;grid-template-columns:2fr .7fr .9fr 2.2fr;gap:8px;padding:11px 12px}
  .thead{background:#0b0e14;color:#aab9d9;font-size:12px;text-transform:uppercase;letter-spacing:.04em}
  .row{border-top:1px solid rgba(255,255,255,.06);align-items:center;cursor:pointer;position:relative}
  .row:hover{filter:brightness(1.04)}
  .row::before{content:"";position:absolute;left:0;top:0;bottom:0;width:4px;border-radius:0 8px 8px 0;opacity:.8}
  .is-locker{background:linear-gradient(180deg, rgba(16,48,99,.40), rgba(16,48,99,.12))}
  .is-locker::before{background:var(--blue)}
  .is-regular{background:linear-gradient(180deg, rgba(68,29,6,.40), rgba(68,29,6,.12))}
  .is-regular::before{background:var(--orange)}

  .name{display:flex;flex-direction:column;gap:2px;min-width:0}
  .name .main{display:flex;align-items:center;gap:6px;min-width:0}
  .name .last{font-weight:700}
  .name .first{opacity:.9}
  .aka{font-size:12px;color:#cfe1ff;opacity:.75}
  .badge{font-size:11px;border-radius:6px;padding:2px 6px;white-space:nowrap;flex:0 0 auto}
  .b-blue{background:rgba(37,99,235,.15);color:#9cc3ff;border:1px solid rgba(37,99,235,.35)}
  .b-orange{background:rgba(234,88,12,.15);color:#ffc9a8;border:1px solid rgba(234,88,12,.35)}
  .pts,.last,.notes{text-align:right}
  .muted{color:var(--muted)}
  .ellipsis{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

  dialog{border:0;padding:0;background:transparent}
  .sheet{width:min(720px,92vw);background:var(--card);border-radius:20px;margin:auto;overflow:hidden;box-shadow:var(--shadow)}
  .sheet header{background:#101625;padding:12px}
  .sheet .body{padding:12px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .rowL{display:flex;justify-content:space-between;gap:8px;padding:9px 0;border-bottom:1px dashed rgba(255,255,255,.06)}
  .rowL:last-child{border-bottom:0}
  .val{font-weight:600}
  .actions{display:flex;justify-content:flex-end;gap:10px;padding:12px}
  .btn{appearance:none;border:1px solid var(--border);background:#0f1629;color:#cfe1ff;border-radius:12px;padding:10px 14px;cursor:pointer}

  @media (max-width:700px){
    .thead,.row{grid-template-columns: 1.9fr .7fr .8fr 1.9fr}
  }
</style>
</head>
<body>
<header>
  <a href="/">← Home</a>
  <h1>Loyalty</h1>
</header>

<div class="wrap">
  <div class="search">
    <input id="q" placeholder="Search name, aka, phone, email, bday, locker #, last visit…"/>
  </div>
  <div class="chips">
    <label class="chip"><input id="fLocker" type="checkbox"/> Locker members</label>
    <label class="chip"><input id="fRegular" type="checkbox"/> Regulars</label>
  </div>

  <div class="list">
    <div class="thead">
      <div>Name</div>
      <div class="pts">Pts</div>
      <div class="last">Last</div>
      <div class="notes">Notes</div>
    </div>
    <div id="rows"></div>
  </div>
</div>

<!-- Profile sheet -->
<dialog id="profile">
  <div class="sheet">
    <header><strong id="pName">Customer</strong></header>
    <div class="body">
      <div class="grid">
        <div>
          <div class="rowL"><div class="muted">Nickname / “aka”</div><div class="val" id="pAka">—</div></div>
          <div class="rowL"><div class="muted">YTD Spend</div><div class="val" id="pYtd">$0.00</div></div>
          <div class="rowL"><div class="muted">Visits (90d)</div><div class="val" id="pVisits">0</div></div>
          <div class="rowL"><div class="muted">Gift Card</div><div class="val" id="pGift">$0.00</div></div>
          <div class="rowL"><div class="muted">Total Points</div><div class="val" id="pPts">0</div></div>
          <div class="rowL"><div class="muted">Last Purchase</div><div class="val" id="pLast">—</div></div>
        </div>
        <div>
          <div class="rowL"><div class="muted">Phone</div><div class="val" id="pPhone">—</div></div>
          <div class="rowL"><div class="muted">Email</div><div class="val" id="pEmail">—</div></div>
          <div class="rowL"><div class="muted">Birthday</div><div class="val" id="pDob">—</div></div>
          <div class="rowL"><div class="muted">Ring Pref</div><div class="val" id="pRing">—</div></div>
          <div class="rowL"><div class="muted">Fav Brands</div><div class="val" id="pFavBrands">—</div></div>
          <div class="rowL"><div class="muted">Fav Cigars</div><div class="val" id="pFavCigars">—</div></div>
          <div class="rowL"><div class="muted">Wishlist</div><div class="val" id="pWishlist">—</div></div>
          <div class="rowL"><div class="muted">Family</div><div class="val" id="pFamily">—</div></div>
        </div>
      </div>
      <div class="rowL"><div class="muted">Notes</div><div class="val" id="pNotes" style="text-align:right;max-width:60ch"></div></div>
    </div>
    <div class="actions">
      <button class="btn" id="closeProfile">Close</button>
    </div>
  </div>
</dialog>

<script>
const rowsEl = document.getElementById('rows');
const q = document.getElementById('q');
const fLocker = document.getElementById('fLocker');
const fRegular = document.getElementById('fRegular');

let base = [];      // from get-loyalty (CSV → JSON)
let enriched = {};  // id -> {points,last,ytd,visits90,gift}

function fmtMoney(n){return '$'+(Math.round(n*100)/100).toFixed(2)}
function safe(v, d='—'){ return (v===0 || (v && String(v).trim()!=='')) ? v : d }

async function loadBase(){
  const r = await fetch('/.netlify/functions/get-loyalty');
  const j = await r.json();
  base = (j.data||[]).map(row=>{
    const id = (row.id||row.customer_id||row.email||row.phone||'').trim();
    const first = row.first_name||row.first||'';
    const last  = row.last_name||row.last||'';
    const aka   = row.aka || row.nickname || '';
    const locker= row.locker || row.locker_number || '';
    return {
      id, first, last, aka,
      phone: row.phone || '', email: row.email || '',
      dob: row.birthday || row.dob || '',
      notes: row.notes || '',
      locker, hasLocker: !!(locker && String(locker).trim()),
      ring_pref: row.ring_pref || row.ring || '',
      fav_brands: row.fav_brands || '',
      fav_cigars: row.fav_cigars || '',
      wishlist: row.wishlist || '',
      family: row.family || row.family_tree || ''
    };
  }).filter(x=>x.id);
}

async function getDetails(id){
  if (enriched[id]) return enriched[id];
  const r = await fetch('/.netlify/functions/get-loyalty-details?id='+encodeURIComponent(id));
  const j = await r.json();
  enriched[id] = {
    points: j.points|0,
    last: j.last || '',
    ytd: Number(j.ytd||0),
    visits90: j.visits90|0,
    gift: Number(j.gift||0)
  };
  return enriched[id];
}

async function enrichVisible(){
  const els = Array.from(document.querySelectorAll('.row[data-id]'));
  for (const el of els){
    const id = el.dataset.id;
    if (!id || el.dataset.enriched==='1') continue;
    const d = await getDetails(id);
    el.querySelector('.pts').textContent = d.points|0;
    el.querySelector('.last').textContent = d.last ? d.last.slice(5) : '—';
    el.dataset.enriched='1';
  }
}

function matchQuery(r, text){
  if (!text) return true;
  const s = text.toLowerCase();
  const inDetails = (id)=>{
    const d = enriched[id];
    if (!d || !d.last) return false;
    return (d.last||'').toLowerCase().includes(s);
  }
  return (
    r.first.toLowerCase().includes(s) ||
    r.last.toLowerCase().includes(s) ||
    (r.aka||'').toLowerCase().includes(s) ||
    (r.phone||'').toLowerCase().includes(s) ||
    (r.email||'').toLowerCase().includes(s) ||
    (r.dob||'').toLowerCase().includes(s) ||
    (String(r.locker||'').toLowerCase().includes(s)) ||
    inDetails(r.id)
  );
}

function passFilters(r){
  const wantLocker = fLocker.checked;
  const wantReg = fRegular.checked;
  if (!wantLocker && !wantReg) return true;
  if (wantLocker && r.hasLocker) return true;
  if (wantReg && !r.hasLocker) return true;
  return false;
}

function render(){
  const text = q.value.trim();
  const arr = base.filter(r => passFilters(r) && matchQuery(r,text));

  rowsEl.innerHTML = arr.map(r=>{
    const colorClass = r.hasLocker ? 'is-locker' : 'is-regular';
    const badge = r.hasLocker ? `<span class="badge b-blue">#${r.locker}</span>`
                              : `<span class="badge b-orange">Regular</span>`;
    const aka = r.aka ? `<span class="aka">aka ${r.aka}</span>` : '';
    return `
      <div class="row ${colorClass}" data-id="${r.id}">
        <div class="name">
          <div class="main">
            ${badge}
            <span class="last ellipsis">${r.last}</span>,
            <span class="first ellipsis">${r.first}</span>
          </div>
          ${aka}
        </div>
        <div class="pts muted">…</div>
        <div class="last muted">—</div>
        <div class="notes muted ellipsis">${(r.notes||'').slice(0,60)}</div>
      </div>
    `;
  }).join('') || `<div class="row"><div class="muted">No matches.</div><div></div><div></div><div></div></div>`;

  enrichVisible();
}

q.addEventListener('input', render);
fLocker.addEventListener('change', render);
fRegular.addEventListener('change', render);

// profile
const dlg = document.getElementById('profile');
document.getElementById('closeProfile').addEventListener('click', ()=>dlg.close());
rowsEl.addEventListener('click', async (e)=>{
  const row = e.target.closest('.row[data-id]');
  if (!row) return;
  const id = row.dataset.id;
  const rec = base.find(x=>x.id===id); if (!rec) return;
  const d = await getDetails(id);

  document.getElementById('pName').textContent = `${rec.first} ${rec.last}`;
  document.getElementById('pAka').textContent = safe(rec.aka);
  document.getElementById('pYtd').textContent = fmtMoney(d.ytd||0);
  document.getElementById('pVisits').textContent = d.visits90|0;
  document.getElementById('pGift').textContent = fmtMoney(d.gift||0);
  document.getElementById('pPts').textContent = d.points|0;
  document.getElementById('pLast').textContent = d.last ? d.last : '—';

  document.getElementById('pPhone').textContent = safe(rec.phone);
  document.getElementById('pEmail').textContent = safe(rec.email);
  document.getElementById('pDob').textContent = safe(rec.dob);
  document.getElementById('pRing').textContent = safe(rec.ring_pref);
  document.getElementById('pFavBrands').textContent = safe(rec.fav_brands);
  document.getElementById('pFavCigars').textContent = safe(rec.fav_cigars);
  document.getElementById('pWishlist').textContent = safe(rec.wishlist);
  document.getElementById('pFamily').textContent = safe(rec.family);
  document.getElementById('pNotes').textContent = safe(rec.notes);

  dlg.showModal();
});

(async function init(){
  await loadBase();
  render();
})();
</script>
</body>
</html>
