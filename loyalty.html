<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Loyalty</title>
  <style>
    :root{
      --bg:#f4f6f9;
      --card:#ffffff;
      --text:#1a1a1a;
      --muted:#6b7280;
      --line:#e5e7eb;
      --blue:#2b6cb0;
      --orange:#dd6b20;
      --chip-bg:#eef2f7;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}

    /* Page shell */
    .wrap{max-width:980px;margin:0 auto;padding:18px 14px 28px;}

    /* Search + chips */
    .searchbar{
      position:sticky;top:0;z-index:5;background:var(--bg);
      padding-bottom:10px;
    }
    .search{
      width:100%;height:56px;border-radius:18px;border:1px solid var(--line);
      background:#fff;padding:0 18px;font-size:20px;outline:none;
      box-shadow:0 1px 0 rgba(0,0,0,.02);
    }
    .chips{display:flex;gap:16px;margin-top:14px;flex-wrap:wrap}
    .chip{
      background:var(--chip-bg);border-radius:14px;padding:10px 14px;
      color:#6b7280;font-weight:600;display:flex;align-items:center;gap:10px;
      user-select:none;
    }
    .dot{width:18px;height:18px;border-radius:6px}
    .dot.blue{background:var(--blue)}
    .dot.orange{background:var(--orange)}
    .chip.active{filter:saturate(1.1);background:#e9eef7;color:#1f2937}

    /* Card / list */
    .card{
      margin-top:14px;background:var(--card);border-radius:18px;padding:12px;
      box-shadow:0 1px 2px rgba(0,0,0,.03), 0 10px 30px rgba(0,0,0,.03);
    }
    .thead{
      display:grid;grid-template-columns:1.2fr .5fr .6fr 1fr;gap:12px;
      color:#374151;font-weight:800;font-size:22px;padding:8px 12px 14px 12px;
    }
    .rows{border-top:1px solid var(--line)}
    .row{
      display:grid;grid-template-columns:1.2fr .5fr .6fr 1fr;gap:12px;
      padding:14px 12px;border-bottom:1px solid var(--line);
      align-items:center;
    }
    .row:last-child{border-bottom:0}
    .name{
      display:flex;flex-direction:column;font-weight:800;font-size:22px;line-height:1.05;
    }
    .locker-tag{font-weight:700;font-size:16px;margin-bottom:4px}
    .pts{font-weight:800;font-size:20px}
    .last{font-weight:700;color:#6b7280;font-size:20px}
    .notes{font-weight:700;color:#6b7280;font-size:20px;overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}

    /* Colored variants */
    .row.locker{
      background:var(--blue);color:#fff;border-bottom-color:rgba(255,255,255,.25)
    }
    .row.locker .last,.row.locker .notes{color:#e6effa}
    .row.regular{
      background:var(--orange);color:#fff;border-bottom-color:rgba(255,255,255,.25)
    }
    .row.regular .last,.row.regular .notes{color:#fff}
    .row.regular .notes{opacity:.95}

    /* Mobile tweaks */
    @media (max-width:640px){
      .thead{font-size:18px}
      .name{font-size:20px}
      .pts,.last,.notes{font-size:18px}
      .row{padding:12px}
    }
  </style>
</head>
<body>
  <div class="wrap">

    <!-- Search & filter chips -->
    <div class="searchbar">
      <input id="q" class="search" type="search" placeholder="Search       Moses…" />
      <div class="chips">
        <div id="chip-locker" class="chip active" role="button" tabindex="0">
          <span class="dot blue"></span> Locker members
        </div>
        <div id="chip-regular" class="chip active" role="button" tabindex="0">
          <span class="dot orange"></span> Regulars
        </div>
      </div>
    </div>

    <!-- List card -->
    <div class="card">
      <div class="thead">
        <div>Name</div>
        <div>Pts</div>
        <div>Last</div>
        <div>Notes</div>
      </div>
      <div id="rows" class="rows"></div>
    </div>
  </div>

  <script>
    // Field map from your dataset
    const F = {
      LOCKER: 'Locker #',
      LAST: 'Last Name',
      FIRST: 'First Name',
      AKA: 'Nickname “aka”',
      POINTS: 'Points',
      LAST_PURCHASE: 'Last Purchase',
      NOTES: 'Notes',
      PHONE: 'Phone',
      EMAIL: 'Email',
      BDAY: 'Birthday'
    };

    let ALL = [];
    let filters = { locker: true, regular: true };

    const $ = (s)=>document.querySelector(s);
    const rowsEl = $('#rows');
    const chipLocker = $('#chip-locker');
    const chipRegular = $('#chip-regular');

    chipLocker.addEventListener('click', ()=>{ filters.locker=!filters.locker; chipLocker.classList.toggle('active',filters.locker); render(); });
    chipRegular.addEventListener('click', ()=>{ filters.regular=!filters.regular; chipRegular.classList.toggle('active',filters.regular); render(); });
    $('#q').addEventListener('input', render);

    function isLocker(r){ return !!(r[F.LOCKER] && String(r[F.LOCKER]).trim()); }
    function fmtPts(v){
      const n = Number(v||0);
      if (!isFinite(n)) return '0';
      if (Math.abs(n) >= 1000) return (n/1000).toFixed(n%1000===0?0:1)+'k';
      return String(n);
    }
    function fmtDate(v){
      if(!v) return '';
      // Keep your existing formats (e.g., "Fri 9/12", "Nov 24", "6/12/23") — don’t reformat aggressively
      return String(v);
    }
    function line(r){
      const lockerNo = isLocker(r)? `#${String(r[F.LOCKER]).trim()}` : '';
      const nameTop = `${r[F.LAST]||''}`;
      const nameBot = `${r[F.FIRST]||''}`;
      const pts = fmtPts(r[F.POINTS]);
      const last = fmtDate(r[F.LAST_PURCHASE]) || '—';
      const notes = r[F.NOTES] ? String(r[F.NOTES]) : '';
      const variant = isLocker(r) ? 'locker' : 'regular';

      return `
        <div class="row ${variant}">
          <div class="name">
            ${lockerNo ? `<div class="locker-tag">${lockerNo}</div>` : ``}
            <div>${nameTop}</div>
            <div>${nameBot}</div>
          </div>
          <div class="pts">${pts}</div>
          <div class="last">${last}</div>
          <div class="notes">${notes}</div>
        </div>`;
    }

    function render(){
      const q = ($('#q').value||'').toLowerCase();
      const list = ALL.filter(r=>{
        const l = isLocker(r);
        if (l && !filters.locker) return false;
        if (!l && !filters.regular) return false;

        if(!q) return true;
        const parts = [
          r[F.LAST], r[F.FIRST], r[F.AKA], r[F.PHONE], r[F.EMAIL],
          r[F.LOCKER], r[F.BDAY], r[F.NOTES]
        ].map(v => (v==null?'':String(v)).toLowerCase());
        return parts.some(p => p.includes(q));
      });
      rowsEl.innerHTML = list.map(line).join('') || `<div style="padding:18px;color:#6b7280;">No results</div>`;
    }

    async function boot(){
      try{
        const res = await fetch('/.netlify/functions/get-loyalty', { cache:'no-store' });
        const json = await res.json();
        if(!json.ok) throw new Error(json.error || 'Load failed');
        // Clean any NaN from upstream (defensive)
        ALL = (json.data||[]).map(r=>{
          const x={...r}; for(const k in x){ if(typeof x[k]==='number' && Number.isNaN(x[k])) x[k]=null; }
          return x;
        });
        render();
      }catch(e){
        rowsEl.innerHTML = `<div style="padding:18px;color:#b91c1c;">Error loading loyalty data: ${e.message}</div>`;
        console.error(e);
      }
    }
    document.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>
